# Keycloak Auth Server (via FastAPI)

## Overview

This project serves as a **lightweight proxy/authentication server** built on top of [Keycloak](https://www.keycloak.org/). It uses **FastAPI** to expose only essential functionality — such as token verification — to reduce unnecessary load on the Keycloak server and simplify integration for downstream services.

Think of it as a **middleware API** that wraps Keycloak, offering a cleaner, faster, and more maintainable interface.

---

## Features

- Automates the creation of:
  - Realms
  - Clients
  - Admin users
- Auto-generates `.env.keycloak-client` for service-side integration
- Provides lightweight token validation endpoints via FastAPI
- Easy environment configuration
- Designed for local development and production environments

---

## Setup Guide

### 1. Start Keycloak

Before running anything, ensure you have Docker installed.

Create a `.env.keycloak` file with the following:

```env
KEYCLOAK_ADMIN=admin
KEYCLOAK_ADMIN_PASSWORD=your_secure_admin_password
```

Then start the Keycloak server using:

```bash
docker-compose up -d
```

### 2. Initialize Keycloak Configuration

Use the setup script to automatically:

- Create a new realm
- Create an internal API client
- Create an initial admin user
- Retrieve the client secret
- Generate .env.keycloak-client with relevant credentials

Run:

```bash
python setup_keycloak.py
```

You will be prompted to enter:

- Keycloak URL (default: http://localhost:8080)
- Realm name
- Admin username
- Admin password
- Admin email (default: default@example.com)
- Admin first name (default: -)
- Admin last name (default: -)
- Client ID (default: internal-api)

### 3. Start the FastAPI Auth Server

Prepare your .env file for FastAPI with:

```env
CORS_ALLOW_ORIGINS=http://localhost:5173,http://localhost:4173
REDIS_HOST=localhost
REDIS_PORT=6379
```

Make sure Redis is running locally or adjust host/port accordingly.

Then launch the FastAPI app:

```bash
uvicorn main:app --reload
```

## Environment Files Summary
- .env.keycloak → Used by Docker to start Keycloak with default admin
- .env.keycloak-client → Auto-generated by setup_keycloak.py and consumed by FastAPI
- .env → Runtime settings for FastAPI, including CORS and Redis

## Recommended Architecture
- Downstream services should decode access tokens themselves using the public JWKs provided by this auth server (see /public-key).
- The auth server should only be contacted when refreshing tokens or for initial login/logout operations.
- Avoid sending every verification request to this auth server — this reduces system load and latency.

## Best Practices
- Use /refresh only when token is expired, not on every request.
- Use /public-key to cache JWKs locally in your service and validate JWTs with jose.jwt.decode().
- Avoid /verify and /verify/user in normal service logic unless absolutely needed.
- Keep API keys used for /public-key secure. Never expose them to clients.

## Note
This setup is not a full replacement for Keycloak’s admin interface, but a minimal API surface for common workflows.
Ideal for microservices environments that require custom or rate-limited access to Keycloak.
For production deployment, make sure HTTPS and proper reverse proxy configurations are in place.